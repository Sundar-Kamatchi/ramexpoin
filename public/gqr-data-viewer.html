<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GQR Data Viewer - Direct Supabase Access</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .data-display {
            margin-top: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .gqr-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .gqr-header {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
        .gqr-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .detail-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
        }
        .detail-label {
            font-weight: bold;
            color: #495057;
            font-size: 0.9em;
        }
        .detail-value {
            color: #212529;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .loading {
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GQR Data Viewer - Direct Supabase Access</h1>
        
        <div class="form-group">
            <label for="supabaseUrl">Supabase URL:</label>
            <input type="url" id="supabaseUrl" placeholder="https://your-project.supabase.co" 
                   value="https://your-project.supabase.co">
        </div>
        
        <div class="form-group">
            <label for="supabaseKey">Supabase Anon Key:</label>
            <input type="password" id="supabaseKey" placeholder="Your Supabase anon key">
        </div>
        
        <div class="form-group">
            <label for="filterStatus">Filter by Tally Posted Status:</label>
            <select id="filterStatus">
                <option value="">All GQR Records</option>
                <option value="false">Not Posted to Tally</option>
                <option value="true">Already Posted to Tally</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="recordLimit">Record Limit:</label>
            <input type="number" id="recordLimit" value="100" min="1" max="1000">
        </div>
        
        <button onclick="fetchGQRData()">Fetch GQR Data</button>
        <button onclick="clearData()">Clear Data</button>
        <button onclick="exportToCSV()">Export to CSV</button>
        
        <div id="status"></div>
        <div id="dataDisplay" class="data-display"></div>
    </div>

    <script>
        let supabaseClient = null;
        let currentData = [];

        async function fetchGQRData() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            const filterStatus = document.getElementById('filterStatus').value;
            const limit = parseInt(document.getElementById('recordLimit').value) || 100;

            if (!url || !key) {
                showStatus('Please enter both Supabase URL and Key', 'error');
                return;
            }

            try {
                showStatus('Connecting to Supabase...', 'loading');
                
                // Initialize Supabase client
                supabaseClient = supabase.createClient(url, key);
                
                // Build the query
                let query = supabaseClient
                    .from('gqr_entry')
                    .select(`
                        *,
                        pre_gr_entry (
                            id,
                            vouchernumber,
                            net_wt,
                            ladden_wt,
                            empty_wt,
                            date,
                            purchase_orders (
                                id,
                                vouchernumber,
                                date,
                                rate,
                                podi_rate,
                                quantity,
                                damage_allowed_kgs_ton,
                                cargo,
                                suppliers (
                                    id,
                                    name
                                ),
                                item_master (
                                    id,
                                    item_name,
                                    hsn_code,
                                    item_unit
                                )
                            )
                        )
                    `)
                    .eq('gqr_status', 'Closed')
                    .order('created_at', { ascending: false })
                    .limit(limit);

                // Apply filter if specified
                if (filterStatus !== '') {
                    query = query.eq('is_tally_posted', filterStatus === 'true');
                }

                showStatus('Fetching data...', 'loading');
                
                const { data: gqrList, error } = await query;

                if (error) {
                    throw error;
                }

                if (!gqrList || gqrList.length === 0) {
                    showStatus('No GQR records found', 'success');
                    document.getElementById('dataDisplay').innerHTML = '<p>No records found.</p>';
                    return;
                }

                // Process the data
                currentData = processGQRData(gqrList);
                displayGQRData(currentData);
                
                showStatus(`Successfully fetched ${currentData.length} GQR records`, 'success');

            } catch (error) {
                console.error('Error:', error);
                showStatus(`Error: ${error.message}`, 'error');
                document.getElementById('dataDisplay').innerHTML = '';
            }
        }

        function processGQRData(gqrList) {
            return gqrList.map(gqrData => {
                const po = gqrData.pre_gr_entry?.purchase_orders;
                const supplier = po?.suppliers;
                const item = po?.item_master;
                const preGr = gqrData.pre_gr_entry;

                if (!po || !supplier || !item) {
                    return null;
                }

                // Calculate actual quantities and rates
                const actualCargoWeight = gqrData.export_quality_weight || gqrData.net_wt || 0;
                const actualPodiWeight = gqrData.podi_weight || 0;
                const actualGapWeight = gqrData.gap_items_weight || 0;
                const actualWastageWeight = (gqrData.rot_weight || 0) + (gqrData.doubles_weight || 0) + (gqrData.sand_weight || 0);
                
                const actualRatePerKg = gqrData.volatile_po_rate || po.rate || 0;
                const actualPodiRatePerKg = gqrData.volatile_podi_rate || po.podi_rate || 0;

                return {
                    gqrId: gqrData.id,
                    voucherNumber: `${preGr.vouchernumber}-GQR${gqrData.id}`,
                    voucherDate: gqrData.date || po.date,
                    supplierName: supplier.name,
                    itemName: item.item_name,
                    itemHSN: item.hsn_code,
                    actualCargoWeight: (actualCargoWeight / 1000).toFixed(3),
                    actualPodiWeight: (actualPodiWeight / 1000).toFixed(3),
                    actualGapWeight: (actualGapWeight / 1000).toFixed(3),
                    actualWastageWeight: (actualWastageWeight / 1000).toFixed(3),
                    ratePerKg: actualRatePerKg,
                    podiRatePerKg: actualPodiRatePerKg,
                    cargoValue: (actualCargoWeight * actualRatePerKg).toFixed(2),
                    podiValue: (actualPodiWeight * actualPodiRatePerKg).toFixed(2),
                    gapValue: (actualGapWeight * actualPodiRatePerKg).toFixed(2),
                    wastageValue: (actualWastageWeight * actualRatePerKg).toFixed(2),
                    totalValue: ((actualCargoWeight * actualRatePerKg) + 
                                 (actualPodiWeight * actualPodiRatePerKg) + 
                                 (actualGapWeight * actualPodiRatePerKg) + 
                                 (actualWastageWeight * actualRatePerKg)).toFixed(2),
                    poVoucherNumber: po.vouchernumber,
                    isTallyPosted: gqrData.is_tally_posted || false,
                    createdAt: gqrData.created_at
                };
            }).filter(item => item !== null);
        }

        function displayGQRData(data) {
            const displayDiv = document.getElementById('dataDisplay');
            
            if (data.length === 0) {
                displayDiv.innerHTML = '<p>No data to display.</p>';
                return;
            }

            const html = data.map(gqr => `
                <div class="gqr-item">
                    <div class="gqr-header">
                        ${gqr.voucherNumber} - ${gqr.supplierName} - ${gqr.itemName}
                    </div>
                    <div class="gqr-details">
                        <div class="detail-item">
                            <div class="detail-label">GQR ID:</div>
                            <div class="detail-value">${gqr.gqrId}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Voucher Date:</div>
                            <div class="detail-value">${gqr.voucherDate}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Supplier:</div>
                            <div class="detail-value">${gqr.supplierName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Item:</div>
                            <div class="detail-value">${gqr.itemName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">HSN Code:</div>
                            <div class="detail-value">${gqr.itemHSN}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Cargo Weight (MT):</div>
                            <div class="detail-value">${gqr.actualCargoWeight}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Podi Weight (MT):</div>
                            <div class="detail-value">${gqr.actualPodiWeight}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Gap Weight (MT):</div>
                            <div class="detail-value">${gqr.actualGapWeight}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Wastage Weight (MT):</div>
                            <div class="detail-value">${gqr.actualWastageWeight}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Rate per KG:</div>
                            <div class="detail-value">₹${gqr.ratePerKg}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Podi Rate per KG:</div>
                            <div class="detail-value">₹${gqr.podiRatePerKg}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Value:</div>
                            <div class="detail-value">₹${gqr.totalValue}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Tally Posted:</div>
                            <div class="detail-value">${gqr.isTallyPosted ? 'Yes' : 'No'}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            displayDiv.innerHTML = html;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function clearData() {
            currentData = [];
            document.getElementById('dataDisplay').innerHTML = '';
            document.getElementById('status').innerHTML = '';
        }

        function exportToCSV() {
            if (currentData.length === 0) {
                showStatus('No data to export', 'error');
                return;
            }

            const headers = [
                'GQR ID', 'Voucher Number', 'Voucher Date', 'Supplier', 'Item', 'HSN Code',
                'Cargo Weight (MT)', 'Podi Weight (MT)', 'Gap Weight (MT)', 'Wastage Weight (MT)',
                'Rate per KG', 'Podi Rate per KG', 'Total Value', 'Tally Posted'
            ];

            const csvContent = [
                headers.join(','),
                ...currentData.map(row => [
                    row.gqrId,
                    `"${row.voucherNumber}"`,
                    row.voucherDate,
                    `"${row.supplierName}"`,
                    `"${row.itemName}"`,
                    row.itemHSN,
                    row.actualCargoWeight,
                    row.actualPodiWeight,
                    row.actualGapWeight,
                    row.actualWastageWeight,
                    row.ratePerKg,
                    row.podiRatePerKg,
                    row.totalValue,
                    row.isTallyPosted ? 'Yes' : 'No'
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `gqr_data_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Auto-fill with environment variables if available
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            // For local development, you can set these in browser console
            // localStorage.setItem('supabaseUrl', 'your-url');
            // localStorage.setItem('supabaseKey', 'your-key');
            
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');
            
            if (savedUrl) document.getElementById('supabaseUrl').value = savedUrl;
            if (savedKey) document.getElementById('supabaseKey').value = savedKey;
        }
    </script>
</body>
</html>
